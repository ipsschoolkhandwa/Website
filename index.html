<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Public School Khandwa - Admissions Open</title>

    <!-- Manifest for PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#004aad">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="logo-hq.png">

    <!-- PWA Mobile Config -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">

    <!-- Push Notification CSS -->
    <style>
        /* Notification Popup */
        .notification-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .notification-popup.active {
            display: flex;
        }

        .popup-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border: 4px solid #004aad;
            animation: slideUp 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .popup-icon {
            font-size: 60px;
            color: #004aad;
            margin-bottom: 20px;
            animation: bellRing 2s ease infinite;
        }

        @keyframes bellRing {
            0%, 100% { transform: rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
            20%, 40%, 60%, 80% { transform: rotate(10deg); }
        }

        .popup-title {
            color: #004aad;
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .popup-message {
            color: #666;
            line-height: 1.6;
            margin-bottom: 25px;
            font-size: 16px;
        }

        .popup-buttons {
            display: flex;
            gap: 15px;
        }

        .popup-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .subscribe-btn {
            background: linear-gradient(135deg, #004aad, #0066cc);
            color: white;
        }

        .subscribe-btn:hover {
            background: linear-gradient(135deg, #0066cc, #004aad);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 74, 173, 0.3);
        }

        .later-btn {
            background: #f0f0f0;
            color: #333;
        }

        .later-btn:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        /* Persistent Bell Icon */
        .bell-status {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #efa12e, #ff9800);
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 22px;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 5px 15px rgba(239, 161, 46, 0.4);
            border: 3px solid white;
            animation: bellFloat 3s ease-in-out infinite;
        }

        .bell-status.active {
            display: flex;
        }

        .bell-status.subscribed {
            background: linear-gradient(135deg, #00bf62, #00d46e);
        }

        @keyframes bellFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #004aad;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            opacity: 0;
            transition: all 0.4s;
            font-weight: 500;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: linear-gradient(135deg, #00bf62, #00d46e);
        }

        .toast.error {
            background: linear-gradient(135deg, #ff4757, #ff6b81);
        }

        /* Admin Link (Small & Hidden) */
        .admin-link {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 74, 173, 0.1);
            color: #004aad;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            text-decoration: none;
            opacity: 0.5;
            transition: opacity 0.3s;
            z-index: 9998;
        }

        .admin-link:hover {
            opacity: 1;
            background: rgba(0, 74, 173, 0.2);
        }

        /* Existing styles remain */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .phone, .phone *, .toast {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        img {
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Notification Popup -->
    <div class="notification-popup" id="notificationPopup">
        <div class="popup-content">
            <div class="popup-icon">
                <i class="fas fa-bell"></i>
            </div>
            <div class="popup-title">Get School Updates</div>
            <div class="popup-message">
                Receive instant notifications about admissions, office timings, 
                YouTube videos, and important announcements directly on your phone.
            </div>
            <div class="popup-buttons">
                <button class="popup-btn later-btn" id="laterBtn">
                    <i class="fas fa-clock"></i> Later
                </button>
                <button class="popup-btn subscribe-btn" id="subscribeBtn">
                    <i class="fas fa-check"></i> Subscribe
                </button>
            </div>
        </div>
    </div>

    <!-- Persistent Bell Icon -->
    <div class="bell-status" id="bellStatus" title="Notification Status">
        <i class="fas fa-bell"></i>
    </div>

    <!-- Admin Link (Small) -->
    <a href="admin.html" class="admin-link" title="Admin Panel">
        <i class="fas fa-cog"></i> Admin
    </a>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Main Content -->
    <div class="container">
        <!-- Header with Logo on left and School Name on right -->
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <picture>
                        <source srcset="logo-hq.png" media="(min-width: 768px) and (min-resolution: 2dppx)">
                        <source srcset="logo.png" media="(min-width: 480px)">
                        <img src="logo.png" 
                             alt="Indian Public School Logo" 
                             class="logo" 
                             crossorigin="anonymous" 
                             loading="eager" 
                             width="140" 
                             height="140"
                             srcset="logo.png 512w, logo-hq.png 1024w"
                             sizes="(max-width: 768px) 140px, 140px">
                    </picture>
                    <div class="logo-ring"></div>
                    <div class="logo-glow"></div>
                </div>
                <div class="school-info">
                    <div class="school-name">
                        <span class="indian">Indian</span>
                        <span class="public">Public</span>
                        <span class="school-text">School</span>
                    </div>
                    <div class="school-location">
                        <span class="khandwa">KHANDWA</span>
                    </div>
                    <p class="tagline">Creating Good Humans</p>
                </div>
            </div>
        </div>

        <div class="admission-box">
            <div class="badge">Admissions Open</div>
            <h2>Registration for Nursery Class</h2>
            <div class="icon"><i class="fas fa-child"></i></div>
        </div>

        <div class="contact-box">
            <h3><i class="fas fa-phone"></i> Contact for Admission</h3>

            <div class="phone">
                <i class="fas fa-mobile-alt"></i>
                <span>+91 7333574759</span>
            </div>

            <div class="buttons">
                <button class="call-btn" id="callBtn">
                    <i class="fas fa-phone"></i> Call Now
                </button>
                <button class="copy-btn" id="copyBtn">
                    <i class="far fa-copy"></i> Copy Number
                </button>
            </div>

            <div class="warning" id="officeHours">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Office Hours: 9:00 AM to 12:00 Noon</p>
            </div>
        </div>

        <div class="info-box">
            <div class="info-item">
                <i class="fas fa-map-marker-alt"></i>
                <div>
                    <h4>Address</h4>
                    <p>Housing Board Colony, Nagchun Road, Khandwa</p>
                </div>
            </div>

            <div class="info-item">
                <i class="far fa-clock"></i>
                <div>
                    <h4>Form Timing</h4>
                    <p>Available at school office: 9 AM to 12 Noon</p>
                </div>
            </div>

            <div class="info-item">
                <i class="fas fa-file-alt"></i>
                <div>
                    <h4>Registration</h4>
                    <p>Visit school office for forms</p>
                </div>
            </div>
        </div>

        <div class="youtube-box">
            <i class="fab fa-youtube"></i>
            <p>Visit our YouTube Channel</p>
            <a href="https://youtube.com/@indianpublicschoolkhandwa5876" target="_blank" id="youtubeLink">
                Watch School Videos
            </a>
        </div>

        <div class="footer">
            <div class="footer-logo">
                <span class="footer-indian">Indian</span>
                <span class="footer-public">Public</span>
                <span class="footer-school">School</span>
            </div>
            <p>© 2024 Indian Public School Khandwa</p>
            <p class="seats">Limited seats available for Nursery Class</p>
            <p class="tech-note">Built with ❤️ by IPS Student</p>
            <p class="push-note" style="font-size: 12px; color: #666; margin-top: 10px;">
                <i class="fas fa-bell"></i> Tap the bell icon to manage notifications
            </p>
        </div>
    </div>

    <!-- Service Worker Registration -->
    <script>
        // Register Push Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw-push.js?v=2.0')
                .then(registration => {
                    console.log('✅ Push Service Worker registered:', registration);
                    
                    // Listen for messages from Service Worker
                    navigator.serviceWorker.addEventListener('message', event => {
                        if (event.data && event.data.type === 'SW_READY') {
                            console.log('Service Worker:', event.data.message);
                        }
                    });
                })
                .catch(error => {
                    console.log('❌ Service Worker registration failed:', error);
                });
        }
    </script>

    <!-- Push Notification JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const notificationPopup = document.getElementById('notificationPopup');
            const subscribeBtn = document.getElementById('subscribeBtn');
            const laterBtn = document.getElementById('laterBtn');
            const bellStatus = document.getElementById('bellStatus');
            const toast = document.getElementById('toast');
            const callBtn = document.getElementById('callBtn');
            const copyBtn = document.getElementById('copyBtn');
            const phone = document.querySelector('.phone');
            const youtubeLink = document.getElementById('youtubeLink');

            const PHONE_NUMBER = '+91 7333574759';
            const SUBSCRIBERS_KEY = 'ips_subscribers';
            const NOTIFICATION_DECISION_KEY = 'ips_notification_decision';
            
            // Check if user already decided
            const notificationDecision = localStorage.getItem(NOTIFICATION_DECISION_KEY);
            const isSubscribed = localStorage.getItem('ips_subscribed') === 'true';

            // Initialize
            initPushNotifications();
            setupContactFunctions();

            // ========== PUSH NOTIFICATION SYSTEM ==========
            function initPushNotifications() {
                // Show popup if user hasn't decided
                if (!notificationDecision) {
                    setTimeout(() => {
                        notificationPopup.classList.add('active');
                    }, 2000); // Show after 2 seconds
                }

                // Update bell status
                updateBellStatus();

                // Subscribe Button Click
                subscribeBtn.addEventListener('click', handleSubscribe);

                // Later Button Click
                laterBtn.addEventListener('click', handleLater);

                // Bell Icon Click
                bellStatus.addEventListener('click', handleBellClick);
            }

            async function handleSubscribe() {
                try {
                    // Request notification permission
                    const permission = await Notification.requestPermission();
                    
                    if (permission === 'granted') {
                        // Save subscription
                        localStorage.setItem(NOTIFICATION_DECISION_KEY, 'subscribed');
                        localStorage.setItem('ips_subscribed', 'true');
                        localStorage.setItem('subscribed_at', new Date().toISOString());
                        
                        // Add to subscribers list
                        const subscribers = JSON.parse(localStorage.getItem(SUBSCRIBERS_KEY) || '[]');
                        const userId = generateUserId();
                        subscribers.push({
                            id: userId,
                            subscribedAt: new Date().toISOString(),
                            lastActive: new Date().toISOString(),
                            device: navigator.userAgent.substring(0, 100),
                            platform: navigator.platform
                        });
                        localStorage.setItem(SUBSCRIBERS_KEY, JSON.stringify(subscribers));
                        
                        // Update UI
                        notificationPopup.classList.remove('active');
                        updateBellStatus();
                        
                        // Show welcome notification
                        showWelcomeNotification();
                        
                        showToast('✅ Successfully subscribed to school updates!', 'success');
                        
                        console.log('Subscriber added. Total:', subscribers.length);
                    } else {
                        showToast('Please allow notifications to receive updates.', 'error');
                    }
                } catch (error) {
                    console.error('Subscription error:', error);
                    showToast('Subscription failed. Please try again.', 'error');
                }
            }

            function handleLater() {
                localStorage.setItem(NOTIFICATION_DECISION_KEY, 'later');
                notificationPopup.classList.remove('active');
                updateBellStatus();
                showToast('You can subscribe later by clicking the bell icon.');
            }

            function handleBellClick() {
                if (isSubscribed) {
                    showToast('You are subscribed to school updates. ✅');
                } else {
                    // Show subscription popup again
                    notificationPopup.classList.add('active');
                }
            }

            function updateBellStatus() {
                const decision = localStorage.getItem(NOTIFICATION_DECISION_KEY);
                
                if (decision) {
                    bellStatus.classList.add('active');
                    
                    if (decision === 'subscribed') {
                        bellStatus.classList.add('subscribed');
                        bellStatus.title = 'Subscribed to updates';
                    } else {
                        bellStatus.title = 'Click to subscribe';
                    }
                }
            }

            function showWelcomeNotification() {
                if ('serviceWorker' in navigator && Notification.permission === 'granted') {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification('Welcome to Indian Public School!', {
                            body: '✅ You will now receive admission updates, office timings, and announcements.',
                            icon: './logo.png',
                            badge: './logo.png',
                            vibrate: [100, 50, 100],
                            tag: 'welcome',
                            renotify: false
                        });
                    });
                }
            }

            // ========== HELPER FUNCTIONS ==========
            function generateUserId() {
                return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            function showToast(message, type = '') {
                toast.textContent = message;
                toast.className = 'toast';
                if (type) {
                    toast.classList.add(type);
                }
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 4000);
            }

            // ========== CONTACT FUNCTIONALITY ==========
            function setupContactFunctions() {
                // Call Button
                if (callBtn) {
                    callBtn.addEventListener('click', function() {
                        window.location.href = 'tel:+917333574759';
                        setTimeout(() => {
                            showToast('If call not started, dial: ' + PHONE_NUMBER);
                        }, 1000);
                    });
                }

                // Copy Button
                if (copyBtn) {
                    copyBtn.addEventListener('click', function() {
                        copyToClipboard(PHONE_NUMBER);
                    });
                }

                // Phone Click
                if (phone) {
                    phone.addEventListener('click', function() {
                        copyToClipboard(PHONE_NUMBER);
                    });
                }

                // YouTube Link Confirmation
                if (youtubeLink) {
                    youtubeLink.addEventListener('click', function(e) {
                        if (!confirm('Opening YouTube channel in new tab. Continue?')) {
                            e.preventDefault();
                        }
                    });
                }

                // Office Hours Check
                checkOfficeHours();
                setInterval(checkOfficeHours, 60000);
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showToast('Phone number copied! ✅');
                    })
                    .catch(() => {
                        // Fallback
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showToast('Number copied to clipboard!');
                    });
            }

            function checkOfficeHours() {
                const now = new Date();
                const hours = now.getHours();
                const warning = document.getElementById('officeHours');
                
                if (warning) {
                    if (hours >= 9 && hours < 12) {
                        warning.innerHTML = '<i class="fas fa-check-circle"></i><p>Office is OPEN - Call Now!</p>';
                        warning.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
                        warning.style.borderLeftColor = '#28a745';
                        warning.style.color = '#155724';
                    } else {
                        warning.innerHTML = '<i class="fas fa-exclamation-triangle"></i><p>Office is CLOSED (9 AM - 12 Noon)</p>';
                        warning.style.background = 'linear-gradient(135deg, #fff8e1, #ffecb3)';
                        warning.style.borderLeftColor = '#efa12e';
                        warning.style.color = '#e65100';
                    }
                }
            }

            // ========== PERIODIC SYNC ==========
            // Sync subscribers count every hour
            setInterval(() => {
                const subscribers = JSON.parse(localStorage.getItem(SUBSCRIBERS_KEY) || '[]');
                console.log('Periodic sync: Total subscribers:', subscribers.length);
            }, 60 * 60 * 1000);

            // ========== DEBUG INFO ==========
            console.log('Push System Status:', {
                decision: localStorage.getItem(NOTIFICATION_DECISION_KEY),
                subscribed: localStorage.getItem('ips_subscribed'),
                subscribers: JSON.parse(localStorage.getItem(SUBSCRIBERS_KEY) || '[]').length
            });
        });
    </script>
</body>
</html>