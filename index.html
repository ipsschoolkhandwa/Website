<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Public School Khandwa - Admissions Open</title>

    <!-- Manifest for PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#004aad">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="logo-hq.png">

    <!-- PWA Mobile Config -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Preload HQ logo for better performance -->
    <link rel="preload" href="logo-hq.png" as="image" type="image/png">
    <link rel="preload" href="logo.png" as="image" type="image/png">
    <link rel="preload" href="style.css" as="style">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">

    <!-- Disable selection -->
    <style>
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .phone, .phone *, .toast {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        img {
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: none;
        }

        /* Subscription Popup Styles */
        .subscription-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .subscription-popup.active {
            display: flex;
        }

        .popup-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 3px solid #004aad;
        }

        .popup-icon {
            font-size: 50px;
            color: #004aad;
            margin-bottom: 15px;
        }

        .popup-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .popup-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .subscribe-btn {
            background: linear-gradient(135deg, #004aad, #0066cc);
            color: white;
        }

        .later-btn {
            background: #f0f0f0;
            color: #333;
        }

        /* Persistent Bell Icon */
        .bell-icon {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #efa12e, #ff9800);
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 22px;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(239, 161, 46, 0.3);
            border: 2px solid white;
            animation: bellFloat 3s ease-in-out infinite;
        }

        .bell-icon.active {
            display: flex;
        }

        .bell-icon.has-notification::after {
            content: '';
            position: absolute;
            top: 5px;
            right: 5px;
            width: 10px;
            height: 10px;
            background: #ff0000;
            border-radius: 50%;
            border: 2px solid white;
        }

        @keyframes bellFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Admin Panel (Hidden by default) */
        .admin-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border: 2px solid #004aad;
            display: none;
            z-index: 9998;
            width: 300px;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #004aad;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 74, 173, 0.3);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #004aad;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Subscription Popup -->
    <div class="subscription-popup" id="subscriptionPopup">
        <div class="popup-content">
            <div class="popup-icon">
                <i class="fas fa-bell"></i>
            </div>
            <h2 style="color: #004aad; margin-bottom: 10px;">Get School Updates</h2>
            <p style="color: #666; margin-bottom: 20px; line-height: 1.5;">
                Receive instant notifications about admissions, office timings, YouTube videos, and important announcements.
            </p>
            <div class="popup-buttons">
                <button class="popup-btn later-btn" id="laterBtn">
                    <i class="fas fa-clock"></i> Later
                </button>
                <button class="popup-btn subscribe-btn" id="popupSubscribeBtn">
                    <i class="fas fa-check"></i> Subscribe
                </button>
            </div>
        </div>
    </div>

    <!-- Persistent Bell Icon -->
    <div class="bell-icon" id="bellIcon" title="Notifications">
        <i class="fas fa-bell"></i>
    </div>

    <!-- Admin Toggle Button -->
    <div class="admin-toggle" id="adminToggle" title="Admin Panel">
        <i class="fas fa-cog"></i>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <h3 style="color: #004aad; margin-bottom: 15px; text-align: center;">
            <i class="fas fa-school"></i> School Admin
        </h3>
        <textarea id="messageInput" placeholder="Type your announcement here..." 
                  style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-family: Arial;"></textarea>
        <button id="sendNotificationBtn" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #00bf62, #00d46e); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
            <i class="fas fa-paper-plane"></i> Send to All Parents
        </button>
        <div style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
            Subscribers: <span id="subscriberCount">0</span>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <div class="container">
        <!-- Header with Logo on left and School Name on right -->
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <!-- Smart picture element: HQ for good screens, normal for others -->
                    <picture>
                        <!-- High-res logo for Retina/4K screens -->
                        <source srcset="logo-hq.png" media="(min-width: 768px) and (min-resolution: 2dppx)">
                        <!-- Medium screens -->
                        <source srcset="logo.png" media="(min-width: 480px)">
                        <!-- Default/fallback for all -->
                        <img src="logo.png" 
                             alt="Indian Public School Logo" 
                             class="logo" 
                             crossorigin="anonymous" 
                             loading="eager" 
                             width="140" 
                             height="140"
                             srcset="logo.png 512w, logo-hq.png 1024w"
                             sizes="(max-width: 768px) 140px, 140px">
                    </picture>
                    <div class="logo-ring"></div>
                    <div class="logo-glow"></div>
                </div>
                <div class="school-info">
                    <div class="school-name">
                        <span class="indian">Indian</span>
                        <span class="public">Public</span>
                        <span class="school-text">School</span>
                    </div>
                    <div class="school-location">
                        <span class="khandwa">KHANDWA</span>
                    </div>
                    <p class="tagline">Creating Good Humans</p>
                </div>
            </div>
        </div>

        <div class="admission-box">
            <div class="badge">Admissions Open</div>
            <h2>Registration for Nursery Class</h2>
            <div class="icon"><i class="fas fa-child"></i></div>
        </div>

        <div class="contact-box">
            <h3><i class="fas fa-phone"></i> Contact for Admission</h3>

            <div class="phone">
                <i class="fas fa-mobile-alt"></i>
                <span>+91 7333574759</span>
            </div>

            <div class="buttons">
                <button class="call-btn" id="callBtn">
                    <i class="fas fa-phone"></i> Call Now
                </button>
                <button class="copy-btn" id="copyBtn">
                    <i class="far fa-copy"></i> Copy Number
                </button>
            </div>

            <div class="warning" id="officeHours">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Office Hours: 9:00 AM to 12:00 Noon</p>
            </div>
        </div>

        <div class="info-box">
            <div class="info-item">
                <i class="fas fa-map-marker-alt"></i>
                <div>
                    <h4>Address</h4>
                    <p>Housing Board Colony, Nagchun Road, Khandwa</p>
                </div>
            </div>

            <div class="info-item">
                <i class="far fa-clock"></i>
                <div>
                    <h4>Form Timing</h4>
                    <p>Available at school office: 9 AM to 12 Noon</p>
                </div>
            </div>

            <div class="info-item">
                <i class="fas fa-file-alt"></i>
                <div>
                    <h4>Registration</h4>
                    <p>Visit school office for forms</p>
                </div>
            </div>
        </div>

        <div class="youtube-box">
            <i class="fab fa-youtube"></i>
            <p>Visit our YouTube Channel</p>
            <a href="https://youtube.com/@indianpublicschoolkhandwa5876" target="_blank" id="youtubeLink">
                Watch School Videos
            </a>
        </div>

        <div class="footer">
            <div class="footer-logo">
                <span class="footer-indian">Indian</span>
                <span class="footer-public">Public</span>
                <span class="footer-school">School</span>
            </div>
            <p>© 2024 Indian Public School Khandwa</p>
            <p class="seats">Limited seats available for Nursery Class</p>
            <p class="tech-note">Built with ❤️ by IPS Student</p>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <!-- Service Worker Registration -->
    <script>
        // Register service worker for push notifications
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            navigator.serviceWorker.register('sw-push.js?v=1')
                .then(registration => {
                    console.log('Push Service Worker registered:', registration);
                })
                .catch(error => {
                    console.log('Push Service Worker registration failed:', error);
                });
        }
    </script>

    <!-- Main Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const subscriptionPopup = document.getElementById('subscriptionPopup');
            const popupSubscribeBtn = document.getElementById('popupSubscribeBtn');
            const laterBtn = document.getElementById('laterBtn');
            const bellIcon = document.getElementById('bellIcon');
            const adminToggle = document.getElementById('adminToggle');
            const adminPanel = document.getElementById('adminPanel');
            const messageInput = document.getElementById('messageInput');
            const sendNotificationBtn = document.getElementById('sendNotificationBtn');
            const subscriberCount = document.getElementById('subscriberCount');
            const toast = document.getElementById('toast');

            const PHONE_NUMBER = '+91 7333574759';
            const CACHE_KEY = 'ips_push_system';
            const SUBSCRIBERS_KEY = 'ips_subscribers';

            // Check if user already decided about notifications
            const notificationDecision = localStorage.getItem('notification_decision');
            const isSubscribed = localStorage.getItem('is_subscribed') === 'true';

            // Show popup if user hasn't decided yet
            if (!notificationDecision) {
                setTimeout(() => {
                    subscriptionPopup.classList.add('active');
                }, 2000); // Show after 2 seconds
            }

            // Show bell icon if user subscribed or clicked "Later"
            if (notificationDecision && (isSubscribed || notificationDecision === 'later')) {
                bellIcon.classList.add('active');
            }

            // Popup Subscribe Button
            popupSubscribeBtn.addEventListener('click', async function() {
                try {
                    // Request notification permission
                    const permission = await Notification.requestPermission();
                    
                    if (permission === 'granted') {
                        // Save subscription
                        localStorage.setItem('notification_decision', 'subscribed');
                        localStorage.setItem('is_subscribed', 'true');
                        localStorage.setItem('subscribed_at', new Date().toISOString());
                        
                        // Add to subscribers list
                        const subscribers = JSON.parse(localStorage.getItem(SUBSCRIBERS_KEY) || '[]');
                        const userId = 'user_' + Date.now();
                        subscribers.push({
                            id: userId,
                            subscribedAt: new Date().toISOString(),
                            lastActive: new Date().toISOString()
                        });
                        localStorage.setItem(SUBSCRIBERS_KEY, JSON.stringify(subscribers));
                        
                        // Update UI
                        subscriptionPopup.classList.remove('active');
                        bellIcon.classList.add('active');
                        updateSubscriberCount();
                        
                        // Show welcome notification
                        if ('serviceWorker' in navigator) {
                            navigator.serviceWorker.ready.then(registration => {
                                registration.showNotification('Indian Public School', {
                                    body: '✅ You are now subscribed to school updates!',
                                    icon: './logo.png',
                                    badge: './logo.png',
                                    vibrate: [100, 50, 100]
                                });
                            });
                        }
                        
                        showToast('✅ Successfully subscribed to school updates!');
                    } else {
                        showToast('Please allow notifications to receive updates.');
                    }
                } catch (error) {
                    console.error('Subscription error:', error);
                    showToast('Subscription failed. Please try again.');
                }
            });

            // Later Button
            laterBtn.addEventListener('click', function() {
                localStorage.setItem('notification_decision', 'later');
                subscriptionPopup.classList.remove('active');
                bellIcon.classList.add('active');
                showToast('You can subscribe later by clicking the bell icon.');
            });

            // Bell Icon Click - Resubscribe or show status
            bellIcon.addEventListener('click', function() {
                if (isSubscribed) {
                    showToast('You are subscribed to school updates.');
                } else {
                    // Show subscription popup again
                    subscriptionPopup.classList.add('active');
                }
            });

            // Admin Toggle
            adminToggle.addEventListener('click', function() {
                adminPanel.classList.toggle('active');
                updateSubscriberCount();
            });

            // Send Notification to All Subscribers
            sendNotificationBtn.addEventListener('click', async function() {
                const message = messageInput.value.trim();
                
                if (!message) {
                    showToast('Please enter a message.');
                    return;
                }

                // Check permission
                if (Notification.permission !== 'granted') {
                    showToast('You need notification permission to send.');
                    return;
                }

                try {
                    // Send notification via Service Worker
                    if ('serviceWorker' in navigator) {
                        const registration = await navigator.serviceWorker.ready;
                        
                        // Send to Service Worker
                        registration.active.postMessage({
                            type: 'SEND_NOTIFICATION',
                            title: 'Indian Public School',
                            body: message,
                            icon: './logo.png'
                        });

                        // Also show locally
                        registration.showNotification('Indian Public School', {
                            body: message,
                            icon: './logo.png',
                            badge: './logo.png',
                            vibrate: [100, 50, 100]
                        });

                        // Save notification
                        saveNotification(message);
                        messageInput.value = '';
                        showToast('✅ Notification sent to all subscribers!');
                    } else {
                        // Fallback: Direct notification
                        new Notification('Indian Public School', {
                            body: message,
                            icon: './logo.png'
                        });
                        showToast('Notification sent (local only).');
                    }
                } catch (error) {
                    console.error('Send error:', error);
                    showToast('Failed to send notification.');
                }
            });

            // Update subscriber count
            function updateSubscriberCount() {
                const subscribers = JSON.parse(localStorage.getItem(SUBSCRIBERS_KEY) || '[]');
                subscriberCount.textContent = subscribers.length;
            }

            // Save notification to history
            function saveNotification(message) {
                const notifications = JSON.parse(localStorage.getItem('notification_history') || '[]');
                notifications.unshift({
                    message: message,
                    sentAt: new Date().toISOString(),
                    sentTo: JSON.parse(localStorage.getItem(SUBSCRIBERS_KEY) || '[]').length
                });
                localStorage.setItem('notification_history', JSON.stringify(notifications.slice(0, 50))); // Keep last 50
            }

            // Show toast message
            function showToast(message) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // Initialize
            updateSubscriberCount();

            // Existing contact functionality (keep your original code here)
            const callBtn = document.getElementById('callBtn');
            const copyBtn = document.getElementById('copyBtn');
            const phone = document.querySelector('.phone');

            if (callBtn) {
                callBtn.addEventListener('click', function() {
                    window.location.href = 'tel:+917333574759';
                    setTimeout(() => {
                        showToast('If call not started, dial: ' + PHONE_NUMBER);
                    }, 1000);
                });
            }

            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    navigator.clipboard.writeText(PHONE_NUMBER)
                        .then(() => showToast('Phone number copied!'))
                        .catch(() => {
                            const textArea = document.createElement('textarea');
                            textArea.value = PHONE_NUMBER;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            showToast('Number copied to clipboard!');
                        });
                });
            }

            if (phone) {
                phone.addEventListener('click', function() {
                    navigator.clipboard.writeText(PHONE_NUMBER)
                        .then(() => showToast('Phone number copied!'));
                });
            }

            // Check office hours
            function checkOfficeHours() {
                const now = new Date();
                const hours = now.getHours();
                const warning = document.getElementById('officeHours');
                
                if (warning) {
                    if (hours >= 9 && hours < 12) {
                        warning.innerHTML = '<i class="fas fa-check-circle"></i><p>Office is OPEN - Call Now!</p>';
                        warning.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
                        warning.style.borderLeftColor = '#28a745';
                        warning.style.color = '#155724';
                    } else {
                        warning.innerHTML = '<i class="fas fa-exclamation-triangle"></i><p>Office is CLOSED (9 AM - 12 Noon)</p>';
                        warning.style.background = 'linear-gradient(135deg, #fff8e1, #ffecb3)';
                        warning.style.borderLeftColor = '#efa12e';
                        warning.style.color = '#e65100';
                    }
                }
            }

            checkOfficeHours();
            setInterval(checkOfficeHours, 60000); // Update every minute
        });
    </script>
</body>
</html>